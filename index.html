<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Version control for reproducible data analysis</title>
    <meta charset="utf-8" />
    <meta name="author" content="Taavi Päll" />
    <meta name="date" content="2023-11-22" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    
    <script src="https://use.fontawesome.com/e4ba4259a1.js"></script>
    <link rel="stylesheet" href="my.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Version control for reproducible data analysis
]
.author[
### Taavi Päll
]
.date[
### 2023-11-22
]

---




class: inverse, center, middle

# Short intro to reproducibility

---
class: important

## Reproducibility

&gt; Calculation of quantitative research results by independent researchers using original data and methods

???

1. You should be able to follow the analysis path of someones results 
from data to final results and obtain numerically close* or identical values.

2. Same numeric results can be obtained from the same data using different calculation methods.

.footnote[[*] Sometimes analysis involves for example random sampling. To make 
such calculations replicable use `set.seed()`.]

---

## Levels of reproducibility

- Reproducibility can be dependent on three levels of information: __empirical, statistical, computational__*.

--

- Empirical reproducibility includes experimental details, used reagents, cell lines, instruments, instrument settings.

--

- Statistical reproducibility includes details about used statistical tests, used models, thresholds.

--

- Computational reproducibility means availability of data, code, workflows, and details of the computational environment.

.footnote[
[*] Stodden, V, McNutt, M, Bailey, DH, Deelman, E, Gil, Y, Hanson, B, Heroux, MA, Ioannidis, JP, Taufer, M (2016). Enhancing reproducibility for computational methods. Science, 354, 6317:1240-1241.
]

---

## Minimal components of computational reproducibility

- Data, 
- Code/scripts, 
- Workflow describing how to generate the results using the data and code. 
- Parameter settings, random number seeds.


???

If you perform your analyses using e.g. R or Python, then statistical reproducibility is also covered by availability of code.


---
class: important

## Computational reproducibility facilitates replication

- More commonly, we want to replicate someone else's analysis workflow on our own data to get comparable results
- We need code, workflow, and parameters

???

We are not pursuing empirical reproducibility -- we bring our own raw data. 

However, there are lots of aspects of computational reproducibility that may not work or can go wrong.

---
class: middle

&lt;img src="img/DJq7RgKX0AENVlO.jpeg" width="2731" style="display: block; margin: auto;" /&gt;

&lt;div&gt;
&lt;blockquote class="twitter-tweet" data-lang="en"&gt;&lt;p lang="en" dir="ltr"&gt;&amp;quot;We have known common problems when developing analysis&amp;quot; here is a list by &lt;a href="https://twitter.com/hspter"&gt;@hspter&lt;/a&gt; and &lt;a href="https://twitter.com/JennyBryan"&gt;@JennyBryan&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/rstats?src=hash"&gt;#rstats&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/EARLconf2017?src=hash"&gt;#EARLconf2017&lt;/a&gt; &lt;a href="https://t.co/fVjlq9Q3OF"&gt;pic.twitter.com/fVjlq9Q3OF&lt;/a&gt;&lt;/p&gt;&amp;mdash; Alice Data (@alice_data) &lt;a href="https://twitter.com/alice_data/status/908244191733538816"&gt;September 14, 2017&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src="//platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;
&lt;/div&gt;

???

Let's discuss what is behind each of these problems

1. Parts of the analysis are not deterministic. Parameters are not described sufficiently. workflow is not described sufficiently.
2. Analysis is not documented sufficently/code is not available.
3. Data is in different shape or format, missing variables.
4. Older versions of the used software/code are not available.
5. Code is broken/not self-sufficient and analysis involves some external actions not implemented in the code. (something that Ülo does alot)
6. Code should be self-sufficient and all analyses should easy to rerun. Keep track of changes in the code and tag and save versions.
7. Save results obtained with new code to a new folder or put also results under version control (if not too big, optimally less than 1 GB)
8. version control not implemented
9. code is not sufficiently documented/commented


10. Follow DRY principle -- don't repeat yourself and wrap some repetitive pieces of code/analyses into functions to reduce errors and enhance readability
11. result of not using DRY principle -- analysis logic is used inconsistently in different parts of analysis
12. Code runs without errors, but the result is incorrect. You don't run tests to assure that code produces correct/expected results, error handling not implemented.
13. You overwrite your raw data with processed data
14. everything can happen... e.g. variable data type is silently changed during import
15. insufficient regular expression can cause bias in results, because only part of the expected matches are found
16. Insufficient knowledge of coding language can lead to a convoluted code posing significant bottleneck for throughput


17. code is not publicly available
18. incompatible licences?
19. version control not implemented, code is not public
20. your collaborators are not using public code repositories, they not in the same skill level



---

## Code/computational reproducibility using git and GitHub

- &lt;i class="fa fa-github fa-lg" aria-hidden="true"&gt;&lt;/i&gt; (_GitHub_) is like a virtual playground for developers. 
- It's a web-based platform that uses &lt;i class="fa fa-git fa-lg" aria-hidden="true"&gt;&lt;/i&gt; for version control, allowing people to collaborate on projects. 
- Developers use it to store and manage their code, track changes, and work together on software projects. 
- It's a hub for open-source collaboration, making it easier for multiple people to contribute to and maintain code. 

&lt;br&gt;&lt;br&gt;
&lt;div class=center&gt;
&lt;img src="https://git-scm.com/images/logos/downloads/Git-Logo-2Color.png" style="max-width:30%;"&gt;
&lt;img src="img/Github_Logo.png" style="max-width:35%;"&gt;
&lt;/div&gt;

.footnote[
Source: ChatGPT3.5
]

???

Think of it as a social network for developers and their code!

---

### Key features of GitHub include

1. Version Control
2. Collaboration
3. Issue Tracking 
4. Wikis 
5. Actions 
6. Projects 
7. Gists 

.footnote[
Sources: 
- ChatGPT3.5; 
- Mine Cetinkaya-Rundel ["Teach datascience to new users"](https://github.com/mine-cetinkaya-rundel/2017-07-05-teach-ds-to-new-user)
- Bryan J. (2017) Excuse me, do you have a moment to talk about version control? PeerJ Preprints 5:e3159v2 https://doi.org/10.7287/peerj.preprints.3159v2
]

???

1. GitHub allows developers to track changes to their code, collaborate with others, and manage different versions of their software.
2.  Developers can work together on projects using GitHub's collaboration features. This includes the ability to fork repositories, submit pull requests to propose changes, and review and discuss code.
3. GitHub provides a built-in issue tracking system that allows developers to report bugs, propose new features, or discuss ideas. Issues can be assigned, labeled, and linked to specific code changes.
4. Each GitHub repository can have its wiki, which is a space for documentation and other project-related information.
5. GitHub Actions allow developers to automate workflows for building, testing, and deploying code directly from their repositories.
6. GitHub Projects provide a way to organize and manage work on a specific feature, bug fix, or any other kind of task.
7. Gists are a way to share snippets or small pieces of code with others. They can be public or private and are often used for sharing examples, troubleshooting code, or collaborating on small projects.

---

## Why &lt;i class="fa fa-git fa-lg" aria-hidden="true"&gt;&lt;/i&gt; and &lt;i class="fa fa-github fa-lg" aria-hidden="true"&gt;&lt;/i&gt; (_GitHub_) is useful

.pull-left[
- __Version control__: lots of mistakes along the way, track history to revert back to last good code.
]

.pull-right[

&lt;img src="img/patmat1.png" width="400" style="display: block; margin: auto;" /&gt;


&lt;img src="img/patmat2.png" width="400" style="display: block; margin: auto;" /&gt;

.footnote[
_Images: Pat&amp;Mat animation._
]

]

---

## Version control: the old way
Example of version control via name.

&lt;img src="img/versioncontrol-oldway.png" width="600" /&gt;

Mastering [version control via name](http://thomasleeper.com/2017/09/my-first-project/).

???

I have seen people keeping their code in MS Word.


---

## Start your code reproducibility by creating an GitHub account

- Create a GitHub account at https://github.com
    - This will be a public account associated with your name
    - Choose a username wisely for future use
    - Don't worry about details, you can fill them later

---

### Create test repo on GitHub
 
- Test repo: create a repository called e.g. `demo`
    - Give a brief and informative description
    - Choose "Public"
    - Check the box for "Initialize this repository with a README"
    - Click "Create Repository"
    
.footer[
Pushing your repo to Github using https now requires  [creating-a-personal-access-token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)
or using Github CLI to authenticate via web browser.
]

---

## Cloning the repository

- Go to RStudio
- File -&gt; New Project
    - Version Control: Checkout a project from a version control repository
    - Fill in the info:
         - URL: use HTTPS address
         - Create as a subdirectory of: Browse and create a new folder called e.g. `rstats2023`


---

## Merge conflicts

- On your repo GitHub website edit the README document and `Commit` it with a message describing what you did.
- Then, in RStudio also edit the README document with a different change.
     - Commit your changes
     - Try to push - you will get an error!
     - Try pulling
     - Resolve the merge conflict and then commit and push
- When collaborating over GitHub and working in teams you run into merge conflicts, and it is very important to learn how to resolve them properly.

---

## To be learned

&gt; Remember to pull before starting to work!

--

- It's impossible to avoid shell: using RStudio interface, you can commit, push-pull, edit .gitignore file, change between branches.

--

- Creating branches must be done on GitHub, in terminal or in some other Git UI.
      - Windows users: learn how to quickly open command prompt/terminal
      - learn how to copy full path to your project folder 

--

- [RStudio](https://www.rstudio.com/products/rstudio/) has tons of features including system shell.

--

- **Discuss with your PI, supervisor when creating public repository of your research project.**

---

## More about using GitHub for version control

Bryan J. (2017) Excuse me, do you have a moment to talk about version control? PeerJ Preprints 5:e3159v2 https://doi.org/10.7287/peerj.preprints.3159v2

---

## What is RStudio project and what is GitHub repo

- [R projects](https://support.posit.co/hc/en-us/articles/200526207-Using-Projects) are standalone folders where your work lives with its own working directory, workspace, history, and source documents.

--

- RStudio project can be used with Git version control by creating local [Git repository](https://www.atlassian.com/git/tutorials/setting-up-a-repository/git-init). 
--

- GitHub is a web-based Git or version control repository and Internet hosting service. 
 
---

## Minimal structure of an data analysis project

```
project/
|- README.md         # description of contents and guide to users
|- my_analysis.Rmd   # markdown file containing analysis
|                    # writeup together with R code chunks
|
|- data/             # raw data, not changed once created 
|  +-my_data.csv     # data files in open formats, 
|                    # such as TXT, CSV, TSV etc.
|
|- scripts/          # any programmatic code
|  +-my_scripts.R    # R code used to analyse and visualise
|  +-my-analysis.Rmd # use "here" package for paths if
|                    # keeping .Rmd files under scripts
|- results/outputs/reports/  # whatever you need
```


.footer[
Marwick B, Boettiger C, Mullen L. (2017) Packaging data analytical work reproducibly using R (and friends) PeerJ Preprints 5:e3192v1 https://doi.org/10.7287/peerj.preprints.3192v1
]

---

## Use projects, never set your working directory manually

&lt;blockquote class="twitter-tweet" data-lang="en"&gt;&lt;p lang="en" dir="ltr"&gt;Use. Projects. — &lt;a href="https://twitter.com/JennyBryan"&gt;@JennyBryan&lt;/a&gt; at &lt;a href="https://twitter.com/hashtag/EARLConf2017?src=hash"&gt;#EARLConf2017&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/rstats?src=hash"&gt;#rstats&lt;/a&gt; &lt;a href="https://t.co/r4a08JhWHT"&gt;pic.twitter.com/r4a08JhWHT&lt;/a&gt;&lt;/p&gt;&amp;mdash; David Smith (@revodavid) &lt;a href="https://twitter.com/revodavid/status/907897658689417217"&gt;September 13, 2017&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src="//platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;

---

## More about organising your data analysis projects


Marwick B, Boettiger C, Mullen L. (2017) Packaging data analytical work reproducibly using R (and friends) PeerJ Preprints 5:e3192v1 https://doi.org/10.7287/peerj.preprints.3192v1

---

## GitHub as internet hosting service
Let's create and publish GitHub hosted webpage for following ggplot demo, 15 min

- Go to your GitHub account and create new repository eg **`ggplotdemo`** (check **Initialize this repository with a README**).

--

- On GitHub create gh-pages branch: 
      - 'Branch: **main**' button &gt; Switch branches/tags &gt; *Find or create a branch* &gt; type into textbox: **gh-pages**

--

- Set gh-pages branch as your default branch
    - '2 branches' tab &gt; Overview &gt; Change default branch &gt; select **gh-pages** from menu &gt; update
    - now you push and pull into gh-pages by default

--
- On GitHub click "Clone or download"

---
## GitHub as internet hosting service, continued

- Go to RStudio

- Clone this repo into your RStudio project "Project"&gt;"New project"&gt;"Version Control"&gt;"Git"
--

  - Create R markdown file:
  
          - File &gt; New File &gt; R Markdown

  - Save this file:
      - Save under name **index.Rmd** (.Rmd is automatically added)
--

- Edit at least title to eg, "ggplot2 demo"

- Knit index.Rmd into html
      - commit all files
      - push 

---

## GitHub as internet hosting service, continued

- Go to: 
    - `https://&lt;your-github-username&gt;.github.io/ggplotdemo`

- What to you see?

---

## You can create webpages, blogs, slidedecks with R markdown and knitr 
We come back to this later during course

- Blogs with `blogdown` https://bookdown.org/yihui/blogdown/

- HTML presentations with `xaringan` Presentation Ninja https://slides.yihui.name/xaringan

---
class: inverse, middle

- Slides are available: https://rstats-tartu.github.io/reproducibility
- &lt;i class="fa fa-github fa-lg" aria-hidden="true"&gt;&lt;/i&gt; [rstats-tartu/reproducibility](https://github.com/rstats-tartu/reproducibility/tree/gh-pages)

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
